#!/usr/bin/env perl

use 5.12.0;

use FindBin;
use lib "$FindBin::Bin/../lib";
use lib "$FindBin::Bin/../extlib/lib/perl5";

use Log::Minimal;
local $Log::Minimal::PRINT = sub {
    my ( $time, $type, $message, $trace,$raw_message) = @_;
    warn "$time [$type] ($PID) $message at $trace\n";
};

use Fluent::Agent;

my $HUPPED = undef;
$SIG{ HUP } = sub { $HUPPED = 1; }; # reopen/reconnect
my $TERMINATED = undef;
$SIG{ INT } = $SIG{ TERM } = sub { $TERMINATED = 1; }; # terminate

my $checker_terminated = sub { $TERMINATED };
my $checker_reconnect = sub {
    if (shift) {
        $HUPPED = undef;
    } else {
        $HUPPED or $TERMINATED;
    }
};

use Getopt::Long;
use Pod::Usage;
my $help = 0;
my $version = 0;
GetOptions(
    'help|h|?' => \$help,
    'version|v' => \$version,
) or pod2usage(1);
pod2usage(1) if $help;

my $xxx;
#TODO
# fluent-agent -i PATH --format ...... -o PATH --keys .....
# fluent-agent -i PATH --format ...... -f host:port -s host:port
# fluent-agent -p port -o PATH --keys .....
# fluent-agent -p port -f host:port
# fluent-agent -i PATH --format ... -x FILTER_COMMAND -X PROC_NUM XXXXXXXXXXXXXXXXXXXXXXX #TODO


#TODO daemonize here (when specified by option in UNIX like system)
#TODO use Win32::Detached ?

__END__

=head1 NAME

fluent-agent  - Fluentd Agent tools, perl implementation

=head1 SYNOPSIS

fluent-agent [options]

  Global Options:

    B<-d,--daemonize> Run in background(daemonized)
    B<-L FILEPATH>    Output fluent-agent's log into I<FILEPATH>

    B<-h,-?,--help>   Brief help message
    B<-v,--version>   Print version number (and exit)

  Input Options:

    B<-i FILEPATH> Read messages from I<FILEPATH> (MUST BE SPECIFIED with B<-I>, exclusive with B<-p>)
    B<-I REGEXP>   Parse regexp pattern, use with B<-i>
    B<-p PORT>     read messages from I<PORT>

    B<--input-file>    Equivalent to B<-i>
    B<--input-pattern> Equivalent to B<-I>
    B<--input-port>    Equivalent to B<-p>

  Output Options:

    B<-o FILEPATH>  Write messages to I<FILEPATH> with TAB separated time, tag and JSON of message (exclusive with B<-f> and B<-s>)
                      FILEPATH parsed as format string like 'strftime' (ex: %Y, %m, %d, %H, %M, %S)
    B<-f HOST:PORT> Forward messages to primary server(s), specified by HOST:PORT
    B<-s HOST:PORT> Forward messages to secondary server(s) when primary servers are down

    B<--output-file>                 Equivalent to B<-o>
    B<--forward-primary HOST:PORT>   Equivalent to B<-f>
    B<--forward-secondary HOST:PORT> Equivalent to B<-s>

  Filter Options:

    B<-x COMMAND>   Filter message between input and output, with executed I<COMMAND>'s STDIN and STDOUT
                      (equivalent with Fluentd's out_exec_filter)

    B<--x-json>     (Default) Serialize/Deserialize messages with JSON (with attributes 'time' and 'tag') on STDIN/STDOUT of filter
    B<--x-msgpack>  Serialize/Deserialize messages with MessagePack

    B<--x-tsv-in KEYS>
                    Serialize messages with TSV on STDIN of filter, fields named by I<KEYS>
    B<--x-tsv-out KEYS>
                    Deserialize messages with TSV on STDOUT of filter, fields named by I<KEYS>

    B<--x-in-time-field FIELDNAME>
                    Serialize messages with time field named as I<FIELDNAME>
    B<--x-out-time-field FIELDNAME>
                    Deerialize messages with time field named as I<FIELDNAME>
    B<--x-time-field FIELDNAME>
                    Same as B<--x-in-time-field FIELDNAME --x-out-time-field FIELDNAME>

    B<--x-tag-field FIELDNAME>
                    Serialize messages with tag field named as I<FIELDNAME>
    B<--x-in-tag-field FIELDNAME>
                    Deserialize messages with tag field named as I<FIELDNAME>
    B<--x-out-tag-field FIELDNAME>
                    Same as B<--x-in-tag-field FIELDNAME --x-out-tag-field FIELDNAME>

    B<--x-remove-prefix TAG_PREFIX>
                    Remove tag prefix before serialization for filter's STDIN
    B<--x-add-prefix TAG_PREFIX>
                    Add tag prefix after deserialization for filter's STDOUT

=head1 OPTIONS

=over 8

=item B<-help>

Print a brief help message and exits.

=back

=head1 DESCRIPTION

B<This program> will read the given input file(s) and do something
useful with the contents thereof.

=cut
